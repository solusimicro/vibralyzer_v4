import time
import paho.mqtt.client as mqtt
from sparkplug_b import Payload
from sparkplug_b_pb2 import Metric

class SparkplugPublisher:

    def __init__(self, broker, port, group_id, edge_node):
        self.group_id = group_id
        self.edge_node = edge_node

        self.client = mqtt.Client()
        self.client.connect(broker, port)
        self.client.loop_start()

    # ==================================================
    # INTERNAL
    # ==================================================
    def _topic(self, msg_type, device_id):
        return f"spBv1.0/{self.group_id}/{msg_type}/{self.edge_node}/{device_id}"

    def _metric(self, name, value):
        m = Metric()
        m.name = name

        if isinstance(value, int):
            m.int_value = value
        else:
            m.float_value = value

        m.timestamp = int(time.time() * 1000)
        return m

    # ==================================================
    # PUBLIC
    # ==================================================
    def publish_ddata(self, asset, point, metrics: dict):
        device_id = f"{asset}_{point}"

        payload = Payload()
        payload.timestamp = int(time.time() * 1000)

        for name, value in metrics.items():
            payload.metrics.append(self._metric(name, value))

        self.client.publish(
            self._topic("DDATA", device_id),
            payload.SerializeToString(),
            qos=0,
            retain=False,
        )
